<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Order History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
    rel="stylesheet"
  />

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    :root {
      --primary: #6c63ff;
      --light: #f0f2f5;
      --card-bg: #ffffff;
      --text: #333333;
      --shadow: rgba(0, 0, 0, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--light);
      color: var(--text);
    }
    h1 {
      font-weight: 600;
      color: var(--primary);
    }
    .container { max-width: 800px; }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .accordion-item {
      background: transparent;
      border: none;
      margin-bottom: 1rem;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.6s ease forwards;
    }
    .accordion-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px var(--shadow);
    }
    .accordion-button {
      background: var(--card-bg);
      color: var(--text);
      border: none;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 12px var(--shadow);
      transition: background 0.3s, color 0.3s;
    }
    .accordion-button.collapsed .arrow {
      transform: rotate(-90deg);
    }
    .accordion-button:not(.collapsed) {
      background: var(--primary);
      color: #fff;
    }
    .accordion-body {
      background: var(--card-bg);
      border-radius: 0 0 8px 8px;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 12px var(--shadow);
    }
    .badge-status {
      font-size: 0.8rem;
      text-transform: uppercase;
      padding: 0.4em 0.65em;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div id="header-container"></div>

  <div class="container py-5">
    <h1 class="text-center mb-4">My Order History</h1>

    <div id="ordersContainer" class="accordion" role="tablist">
      <div id="loading" class="d-flex justify-content-center align-items-center" style="height:200px;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading‚Ä¶</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Load header.html
    $('#header-container').load('/header.html');

    async function loadHistory() {
      const userID = localStorage.getItem('userID');
      const token  = localStorage.getItem('token');
      const container = $('#ordersContainer');
      $('#loading').show();

      if (!userID || !token) {
        $('#loading').remove();
        container.html('<div class="alert alert-warning">Please log in first.</div>');
        return;
      }

      try {
        const res = await fetch(`/api/orders/history/${userID}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const { success, orders } = await res.json();
        $('#loading').remove();

        if (!success) {
          container.html('<div class="alert alert-danger">Failed to load orders.</div>');
          return;
        }
        if (orders.length === 0) {
          container.html('<p class="text-center text-muted">You have no past orders.</p>');
          return;
        }

        // sort newest ‚Üí oldest
        orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

        container.html(
          orders.map((o, idx) => {
            const collapseId = `collapseOrder${o.orderID}`;
            const headerId   = `headingOrder${o.orderID}`;
            const statusClasses = {
              pending:   'bg-secondary',
              confirmed: 'bg-info',
              shipped:   'bg-warning text-dark',
              delivered: 'bg-success',
              cancelled: 'bg-danger'
            };
            const badgeClass = statusClasses[o.status] || 'bg-secondary';

            // hide action buttons if delivered or cancelled
            const isFinal = o.status === 'delivered' || o.status === 'cancelled';

            return `
            <div class="accordion-item" style="animation-delay:${idx * 0.1}s">
              <h2 class="accordion-header" id="${headerId}">
                <button
                  class="accordion-button collapsed d-flex justify-content-between align-items-center"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#${collapseId}"
                  aria-expanded="false"
                  aria-controls="${collapseId}">
                  <div>
                    <i class="fas fa-box-open me-2"></i>
                    Order #${o.orderID}
                    <small class="text-muted ms-2">
                      <i class="fas fa-calendar-alt me-1"></i>
                      ${new Date(o.orderDate).toLocaleString()}
                    </small>
                  </div>
                  <div class="text-end">
                    <span class="badge badge-status ${badgeClass} me-3">${o.status}</span>
                    <strong>‚Ç±${parseFloat(o.totalAmount).toFixed(2)}</strong>
                    <i class="fas fa-chevron-down ms-2 arrow"></i>
                  </div>
                </button>
              </h2>
              <div
                id="${collapseId}"
                class="accordion-collapse collapse"
                aria-labelledby="${headerId}"
                data-bs-parent="#ordersContainer">
                <div class="accordion-body">
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <i class="fas fa-credit-card me-1"></i>
                      <strong>Payment:</strong> ${o.paymentMethod.toUpperCase()}
                    </div>
                    <div class="col-md-6">
                      <i class="fas fa-truck me-1"></i>
                      <strong>Ship To:</strong> ${o.shippingAddress}
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table mb-3">
                      <thead>
                        <tr>
                          <th>Product</th>
                          <th class="text-center">Qty</th>
                          <th class="text-end">Unit Price</th>
                          <th class="text-end">Line Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${o.items.map(i => `
                          <tr>
                            <td>${i.name}</td>
                            <td class="text-center">${i.quantity}</td>
                            <td class="text-end">‚Ç±${parseFloat(i.priceAtPurchase).toFixed(2)}</td>
                            <td class="text-end">‚Ç±${parseFloat(i.lineTotal).toFixed(2)}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                      <tfoot>
                        <tr>
                          <th colspan="3" class="text-end">Grand Total:</th>
                          <th class="text-end">‚Ç±${parseFloat(o.totalAmount).toFixed(2)}</th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>

                  ${!isFinal ? `
                    <div class="mt-3 text-end">
                      <button class="btn btn-danger me-2"
                              onclick="cancelOrder(${o.orderID})">
                        Cancel Delivery
                      </button>
                      <button class="btn btn-success"
                              onclick="completeOrder(${o.orderID})">
                        Mark as Received
                      </button>
                    </div>
                  ` : ''}
                  
                  <div class="mt-3 text-end">
                    <button class="btn btn-outline-primary"
                            onclick="window.location.href='feedback.html?email='+encodeURIComponent(localStorage.getItem('email'))+'&orderID=${o.orderID}'">
                      üìù Give / View Feedback
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
          }).join('')
        );
      } catch (e) {
        $('#loading').remove();
        container.html(`<div class="alert alert-danger">Error: ${e.message}</div>`);
      }
    }

    async function cancelOrder(orderID) {
      if (!confirm(`Cancel order #${orderID}?`)) return;
      const email = localStorage.getItem('email');
      try {
        const res = await fetch(`/api/orders/${orderID}/status`, {
          method: 'PATCH',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({status:'cancelled', email})
        });
        if (!res.ok) throw await res.json();
        Swal.fire('Cancelled','Your order has been cancelled.','info');
        setTimeout(loadHistory, 500);
      } catch (err) {
        Swal.fire('Error', err.message || err.error || 'Failed to cancel order.','error');
      }
    }

    async function completeOrder(orderID) {
      if (!confirm(`Mark order #${orderID} as received?`)) return;
      const email = localStorage.getItem('email');
      try {
        let res = await fetch(`/api/orders/${orderID}/status`, {
          method: 'PATCH',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({status:'delivered', email})
        });
        if (!res.ok) throw await res.json();

        // prompt feedback
        const orderRes = await fetch(`/api/orders/orderinfo/${orderID}`);
        const { items } = await orderRes.json();
        for (const item of items) {
          const { value: formValues } = await Swal.fire({
            title: `Review: ${item.name}`,
            html: `
              <label>Your Rating for <strong>${item.name}</strong>:</label>
              <div id="stars-${item.productID}" class="starContainer"></div>
              <textarea id="feedback-${item.productID}" class="swal2-textarea" placeholder="Write your feedback here..." required></textarea>
            `,
            showCancelButton: true,
            confirmButtonText: 'Submit',
            cancelButtonText: 'Skip',
            preConfirm: () => {
              const rating = document.querySelectorAll(`#stars-${item.productID} span.filled`).length;
              const feedbackText = document.getElementById(`feedback-${item.productID}`).value.trim();
              if (rating === 0 || feedbackText === "") {
                Swal.showValidationMessage("‚ö†Ô∏è Please provide both a star rating and written feedback.");
                return false;
              }
              return {rating, feedback: feedbackText};
            },
            didOpen: () => {
              const container = document.getElementById(`stars-${item.productID}`);
              for (let i=1; i<=5; i++){
                const star = document.createElement("span");
                star.textContent = "‚òÖ";
                star.style.fontSize = "24px";
                star.style.cursor = "pointer";
                star.style.color = "#ccc";
                star.addEventListener("click", () => {
                  container.querySelectorAll("span").forEach((s, idx) => {
                    s.style.color = idx < i ? "#f1c40f" : "#ccc";
                    s.classList.toggle("filled", idx < i);
                  });
                });
                container.appendChild(star);
              }
            }
          });
          if (formValues) {
            await fetch("/api/feedback", {
              method: "POST",
              headers: {"Content-Type":"application/json"},
              body: JSON.stringify({
                orderID,
                productID: item.productID,
                email,
                feedback: formValues.feedback,
                rating: formValues.rating
              })
            });
          }
        }

        Swal.fire({
          icon: 'success',
          title: 'Feedback submitted!',
          text: 'Thank you for your reviews.',
          timer: 2000,
          showConfirmButton: false
        }).then(() => loadHistory());
      } catch (err) {
        Swal.fire('Error', err.message || err.error || 'Failed to update order.','error');
      }
    }

    // initialize
    loadHistory();
  </script>
</body>
</html>
