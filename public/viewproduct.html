<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f0f4ff;
      --card: #fff;
      --accent: #6c63ff;
      --text: #222;
      --muted: #666;
      --danger: #e74c3c;
    }

    body {
      margin: 0;
      padding: 0px 0px;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--accent);
    }

    .product-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }

    .product-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      text-align: center;
      transition: transform 0.2s ease;
    }

    .product-card:hover {
      transform: translateY(-4px);
    }

    .product-card img {
      width: 100%;
      height: 160px;
      object-fit: contain;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .product-card h3 {
      margin: 10px 0 4px;
      font-size: 18px;
      color: var(--text);
    }

    .product-card p {
      font-size: 14px;
      color: var(--muted);
      margin: 4px 0;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .actions button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }

    .actions button:first-child {
      background-color: var(--accent);
      color: #fff;
    }

    .actions button:last-child {
      background-color: var(--danger);
      color: #fff;
    }

    #status {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
      color: red;
    }

    .thumbnails {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 8px;
    }

    .thumbnails img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* ‚úÖ Enhanced Delete Confirmation Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .modal-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .confirm-delete {
      background-color: var(--danger);
      color: white;
    }

    .cancel-delete {
      background-color: #6c757d;
      color: white;
    }
  </style>
</head>
<body style="display: none;">
  <script>
    // ‚úÖ IMMEDIATE admin check - runs before anything else loads
    console.log("üöÄ IMMEDIATE admin check starting for viewproduct.html...");
    
    // Get auth data immediately
    const token = sessionStorage.getItem("jwtToken") || localStorage.getItem("jwtToken") ||
                  sessionStorage.getItem("token") || localStorage.getItem("token");
    const role = sessionStorage.getItem("role") || localStorage.getItem("role");
    
    console.log("Token present:", !!token);
    console.log("User role:", role);
    console.log("sessionStorage contents:", {
      jwtToken: sessionStorage.getItem("jwtToken"),
      token: sessionStorage.getItem("token"),
      role: sessionStorage.getItem("role"),
      name: sessionStorage.getItem("name")
    });
    console.log("localStorage contents:", {
      jwtToken: localStorage.getItem("jwtToken"),
      token: localStorage.getItem("token"),
      role: localStorage.getItem("role"),
      name: localStorage.getItem("name")
    });
    
    // If not admin, redirect immediately
    if (!token) {
      console.log("‚ùå No token - redirecting to login");
      alert("Please log in to access this page.");
      window.location.replace("/login.html");
    } else if (role !== "admin") {
      console.log("‚ùå Not admin - redirecting to home");
      alert(`Access denied. Administrator privileges required.\nYour role: ${role}\n\nRedirecting to home page...`);
      window.location.replace("/home.html");
    } else {
      console.log("‚úÖ Admin access granted - showing page");
      document.body.style.display = "block";
    }
  </script>
  <div id="header-container"></div>

  <h1>Product Catalog</h1>
  <div id="productList" class="product-list"></div>
  <p id="status"></p>

  <!-- ‚úÖ Enhanced Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>‚ö†Ô∏è Confirm Delete</h3>
      <p>Are you sure you want to delete this product?</p>
      <p><strong id="productToDelete"></strong></p>
      <p style="color: red; font-size: 14px;">This action cannot be undone!</p>
      <div class="modal-buttons">
        <button class="cancel-delete" onclick="closeDeleteModal()">Cancel</button>
        <button class="confirm-delete" onclick="confirmDelete()">Delete Product</button>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    let productToDeleteId = null;

   async function loadProducts() {
  const productList = document.getElementById("productList");
  const status = document.getElementById("status");
  productList.innerHTML = "<p>Loading...</p>";

  try {
    const res = await fetch("/api/products");
    const products = await res.json();

    if (products.length === 0) {
      productList.innerHTML = "<p>No products found.</p>";
      return;
    }

    productList.innerHTML = "";

    products.forEach(product => {
      const card = document.createElement("div");
      card.className = "product-card";

      // Find main image
      let mainImage = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='160' viewBox='0 0 240 160'%3E%3Crect width='240' height='160' fill='%23f5f5f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='14' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E";
      if (product.images && product.images.length > 0) {
        const main = product.images.find(img => img.isMain == 1);
        mainImage = main
          ? `/uploads/${main.filename}`
          : `/uploads/${product.images[0].filename}`;
      }

      // Build thumbnail HTML
      let thumbnails = "";
      if (product.images && product.images.length > 1) {
        thumbnails = `<div class="thumbnails">`;
        product.images.forEach((img, idx) => {
          thumbnails += `<img src="/uploads/${img.filename}" alt="thumb" onclick="showMainImage(this, '${img.filename}', ${product.productID})" />`;
        });
        thumbnails += `</div>`;
      }

      // Card content
      card.innerHTML = `
        <img id="main-img-${product.productID}" src="${mainImage}" alt="${product.name}" />
        ${thumbnails}
        <h3>${product.name}</h3>
        <p><strong>Brand:</strong> ${product.brand}</p>
        <p><strong>Price:</strong> ‚Ç±${parseFloat(product.price).toFixed(2)}</p>
        <p><strong>RAM:</strong> ${product.ram}</p>
        <p><strong>Storage:</strong> ${product.storage}</p>
        <p><strong>Quantity:</strong> ${product.quantity}</p>
        <p><strong>Status:</strong> ${product.availability == 1 ? "Available" : "Unavailable"}</p>
        <div class="actions">
          <button onclick="editProduct(${product.productID})">‚úèÔ∏è Edit</button>
          <button class="delete-btn" data-id="${product.productID}" data-name="${product.name.replace(/"/g, '&quot;')}">üóë Delete</button>
        </div>
      `;

      productList.appendChild(card);

      // ‚úÖ Bind delete button for this card after append
      const deleteBtn = card.querySelector(".delete-btn");
      if (deleteBtn) {
        deleteBtn.addEventListener("click", () => {
          const id = deleteBtn.getAttribute("data-id");
          const name = deleteBtn.getAttribute("data-name");
          openDeleteModal(id, name);
        });
      }
    });
  } catch (err) {
    console.error(err);
    status.textContent = "Failed to load products.";
  }
}


    // ‚úÖ Enhanced Delete Modal Functions
    function openDeleteModal(id, productName) {
      productToDeleteId = id;
      document.getElementById('productToDelete').textContent = productName;
      document.getElementById('deleteModal').style.display = 'block';
    }

    function closeDeleteModal() {
      productToDeleteId = null;
      document.getElementById('deleteModal').style.display = 'none';
    }

    async function confirmDelete() {
      if (!productToDeleteId) return;

      try {
        // Get JWT token from storage
        const token = localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken");
        
        if (!token) {
          $("#status").text("Authentication required. Please log in again.").css("color", "red");
          closeDeleteModal();
          setTimeout(() => {
            window.location.href = "/login.html";
          }, 2000);
          return;
        }

        // Show loading state
        const deleteBtn = document.querySelector('.confirm-delete');
        const originalText = deleteBtn.textContent;
        deleteBtn.textContent = 'Deleting...';
        deleteBtn.disabled = true;

        const res = await fetch(`/api/products/${productToDeleteId}`, {
          method: "DELETE",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });

        if (res.status === 401) {
          throw new Error("Authentication expired. Please log in again.");
        }

        const result = await res.json();
        
        if (res.ok) {
          closeDeleteModal();
          loadProducts(); // refresh list
          $("#status").text(result.message || "Product deleted successfully").css("color", "green");
          
           deleteBtn.textContent = originalText;
  deleteBtn.disabled = false;
          // Clear status after 3 seconds
          setTimeout(() => {
            $("#status").text("");
          }, 3000);
        } else {
          throw new Error(result.message || "Failed to delete product");
        }
      } catch (err) {
        console.error(err);
        if (err.message.includes("Authentication expired")) {
          $("#status").text(err.message).css("color", "red");
          closeDeleteModal();
          setTimeout(() => {
            window.location.href = "/login.html";
          }, 2000);
        } else {
          $("#status").text(err.message || "Failed to delete product").css("color", "red");
          
          // Reset button state
          const deleteBtn = document.querySelector('.confirm-delete');
          deleteBtn.textContent = 'Delete Product';
          deleteBtn.disabled = false;
        }
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('deleteModal');
      if (event.target === modal) {
        closeDeleteModal();
      }
    }

    function editProduct(id) {
      window.location.href = `/editproduct.html?id=${id}`;
    }

    function showMainImage(el, filename, productID) {
      document.getElementById(`main-img-${productID}`).src = `/uploads/${filename}`;
    }

    // ‚úÖ Load products when page loads
    loadProducts();
  </script>

  <script>
    // ‚úÖ Enhanced Admin-only page protection with SweetAlert
    function checkAdminAccess() {
      // Prioritize jwtToken as requested
      const token = sessionStorage.getItem("jwtToken") || localStorage.getItem("jwtToken") ||
                    sessionStorage.getItem("token") || localStorage.getItem("token");
      const role = sessionStorage.getItem("role") || localStorage.getItem("role");
      
      console.log("üîê Checking admin access for viewproduct.html");
      console.log("Token present:", !!token);
      console.log("User role:", role);
      
      if (!token) {
        console.log("‚ùå No authentication token found - redirecting to login");
        
        Swal.fire({
          icon: 'warning',
          title: 'Authentication Required',
          text: 'Please log in to access this page.',
          confirmButtonText: 'Go to Login',
          confirmButtonColor: '#6c63ff',
          allowOutsideClick: false
        }).then(() => {
          window.location.href = "/login.html";
        });
        return false;
      }
      
      if (role !== "admin") {
        console.log(`‚ùå Access denied - Role: ${role}, Required: admin`);
        
        Swal.fire({
          icon: 'error',
          title: 'Access Denied',
          text: `You are not authorized to access this page. Administrator privileges required.\n\nYour role: ${role || 'none'}`,
          confirmButtonText: 'Go to Home',
          confirmButtonColor: '#6c63ff',
          allowOutsideClick: false
        }).then(() => {
          window.location.href = "/home.html";
        });
        return false;
      }
      
      console.log("‚úÖ Admin access granted");
      return true;
    }
    
    // Check access immediately when page loads
    if (!checkAdminAccess()) {
      // If access check fails, stop page execution
      document.body.style.display = 'none';
    }
  </script>

  <script>
    // Load header and check admin role (prioritize jwtToken)
    $("#header-container").load("header.html", function () {
      const role = sessionStorage.getItem("role") || localStorage.getItem("role");
      if (role === "admin") {
        const editUsersLink = document.getElementById("editUsersLink");
        const dashboardLink = document.getElementById("dashboardLink");
        if (editUsersLink) editUsersLink.style.display = "inline-block";
        if (dashboardLink) dashboardLink.style.display = "inline-block";
      }
    });
  </script>

</body>
</html>
