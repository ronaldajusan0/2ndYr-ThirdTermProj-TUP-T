<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- DataTables CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  />

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4ff;
      margin: 0; padding: 20px;
    }
    /* leave space for sticky header */
    #header-container { position: sticky; top: 0; z-index: 1000; }
    h1 {
      text-align: center;
      color: #6c63ff;
      margin: 20px 0;
    }
    table.dataTable {
      width: 100%;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      overflow: hidden;
    }
    table.dataTable thead {
      background: linear-gradient(90deg, #6c63ff, #574ee0);
      color: #fff;
    }
    table.dataTable img {
      max-width: 60px;
      border-radius: 4px;
    }
    .actions button {
      margin: 0 4px;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    .actions .edit-btn { background: #6c63ff; }
    .actions .delete-btn { background: #e74c3c; }

    /* Simple delete‑modal */
    .modal {
      display: none;
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      align-items: center; justify-content: center;
    }
    .modal-content {
      background: #fff; padding:20px;
      border-radius:8px; text-align:center;
      max-width:400px; width:90%;
    }
    .modal-content button {
      margin:0 8px; padding:8px 16px;
      border:none; border-radius:4px;
      cursor:pointer; color:#fff;
    }
    .confirm-delete { background: #e74c3c; }
    .cancel-delete  { background: #6c757d; }

    #status { text-align:center; color:red; margin-top:10px; }
  </style>
</head>
<body>

  <!-- 1) Header goes here -->
  <div id="header-container"></div>

  <h1>Product Catalog</h1>

  <!-- 2) DataTable -->
  <table id="productsTable" class="display">
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Brand</th><th>Price</th>
        <th>RAM</th><th>Storage</th><th>Available</th>
        <th>Image</th><th>Qty</th><th>Description</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 3) Delete Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>Confirm Delete</h3>
      <p>Delete <strong id="productToDelete"></strong>?</p>
      <button class="cancel-delete" onclick="closeDeleteModal()">Cancel</button>
      <button class="confirm-delete" onclick="confirmDelete()">Delete</button>
    </div>
  </div>

  <div id="status"></div>

  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"
  ></script>

  <script>
    let productToDeleteId = null;
    const token = sessionStorage.getItem("jwtToken") || localStorage.getItem("jwtToken");

    // ─── Load header and strip out duplicate jQuery ─────────────────────────────
    $.get('header.html', function(data) {
      const $hdr = $('<div>').html(data);

      // Remove any <script> that re-imports jQuery
      $hdr.find('script[src*="jquery"]').remove();

      // Insert navbar markup
      $('#header-container').html( $hdr.find('.navbar') );

      // Execute remaining scripts (logout, admin links, cart count)
      $hdr.find('script').each(function() {
        const src = $(this).attr('src');
        if (src) {
          // external script (not jQuery)
          const s = document.createElement('script');
          s.src = src;
          document.body.appendChild(s);
        } else {
          // inline script
          $.globalEval( $(this).text() );
        }
      });
    });

    // ─── Initialize DataTable ─────────────────────────────────────────────────
    $(document).ready(async function() {
      if (!token) {
        alert("Please log in");
        return window.location.href = "/login.html";
      }

      try {
        const res = await fetch("/api/products", {
          headers: { "Authorization": "Bearer " + token }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload  = await res.json();
        const products = payload.products || payload;

        $('#productsTable').DataTable({
          data: products,
          columns: [
            { data: "productID" },
            { data: "name" },
            { data: "brand" },
            { data: "price",
              render: p => "₱" + parseFloat(p).toFixed(2)
            },
            { data: "ram" },
            { data: "storage" },
            { data: "availability",
              render: a => a==1 ? "Yes" : "No"
            },
            { data: "image",
              render: img => img
                ? `<img src="/uploads/${img.split(',')[0]}" alt="" />`
                : `-`
            },
            { data: "quantity" },
            { data: "description" },
            {
              data: null,
              orderable: false,
              render: row => `
                <div class="actions">
                  <button class="edit-btn"
                    onclick="editProduct(${row.productID})">✏️</button>
                  <button class="delete-btn"
                    onclick="openDeleteModal(${row.productID}, '${row.name.replace(/'/g,"\\'")}')">
                    🗑
                  </button>
                </div>`
            }
          ],
          pageLength: 10,
          lengthMenu: [5,10,25],
          responsive: true
        });
      } catch (err) {
        console.error(err);
        $('#status').text("Failed to load products: " + err.message);
      }
    });

    // ─── Actions ──────────────────────────────────────────────────────────────
    function editProduct(id) {
      window.location.href = `/editproduct.html?id=${id}`;
    }

    function openDeleteModal(id, name) {
      productToDeleteId = id;
      $('#productToDelete').text(name);
      $('#deleteModal').css('display','flex');
    }

    function closeDeleteModal() {
      productToDeleteId = null;
      $('#deleteModal').hide();
    }

    async function confirmDelete() {
      if (!productToDeleteId) return;
      try {
        const res = await fetch(`/api/products/${productToDeleteId}`, {
          method: "DELETE",
          headers: { "Authorization": "Bearer " + token }
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.message || "Delete failed");

        closeDeleteModal();
        // remove the row from DataTable
        $('#productsTable').DataTable()
          .row( $(`button[onclick*="(${productToDeleteId})"]`).parents('tr') )
          .remove().draw();

        $('#status').css('color','green')
                    .text(result.message || "Deleted");
      } catch (e) {
        console.error(e);
        $('#status').text("Delete error: " + e.message);
      }
    }
  </script>
</body>
</html>
