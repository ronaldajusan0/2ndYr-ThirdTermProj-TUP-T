<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Product</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #f6f8ff;
      --accent: #6c63ff;
      --light: #ffffff;
      --text: #333;
      --muted: #777;
    }

    body {
      background: var(--primary);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    #header-container {
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      height: 80px;
      z-index: 100;
    }

    .form-card {
      background: var(--light);
      border-radius: 14px;
      padding: 30px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin-top: 120px; /* Pushes form below fixed header */
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--accent);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      background: #f9f9f9;
      transition: border 0.2s;
      font-size: 14px;
      box-sizing: border-box;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      background: #fff;
      outline: none;
    }

    textarea {
      resize: vertical;
      font-family: inherit;
    }

    small {
      color: var(--muted);
      font-size: 12px;
      display: block;
      margin-top: 4px;
    }

    .full-width {
      grid-column: span 2;
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 20px;
      background: var(--accent);
      color: white;
      font-weight: bold;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #574ee0;
    }

    #status {
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
      color: #28a745;
    }

    /* ‚úÖ jQuery Validation Error Styles */
    .error {
      color: #dc3545;
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    
    input.error, select.error, textarea.error {
      border-color: #dc3545 !important;
      background-color: #ffe6e6 !important;
    }
    
    input.valid, select.valid, textarea.valid {
      border-color: #28a745 !important;
      background-color: #e6ffe6 !important;
    }

    @media (max-width: 600px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .full-width {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body style="display: none;">
  <script>
    // ‚úÖ IMMEDIATE admin check - runs before anything else loads
    console.log("üöÄ IMMEDIATE admin check starting for editproduct.html...");
    
    // Get auth data immediately
    const token = sessionStorage.getItem("jwtToken") || localStorage.getItem("jwtToken") ||
                  sessionStorage.getItem("token") || localStorage.getItem("token");
    const role = sessionStorage.getItem("role") || localStorage.getItem("role");
    
    console.log("Token present:", !!token);
    console.log("User role:", role);
    console.log("sessionStorage contents:", {
      jwtToken: sessionStorage.getItem("jwtToken"),
      token: sessionStorage.getItem("token"),
      role: sessionStorage.getItem("role"),
      name: sessionStorage.getItem("name")
    });
    console.log("localStorage contents:", {
      jwtToken: localStorage.getItem("jwtToken"),
      token: localStorage.getItem("token"),
      role: localStorage.getItem("role"),
      name: localStorage.getItem("name")
    });
    
    // If not admin, redirect immediately
    if (!token) {
      console.log("‚ùå No token - redirecting to login");
      alert("Please log in to access this page.");
      window.location.replace("/login.html");
    } else if (role !== "admin") {
      console.log("‚ùå Not admin - redirecting to home");
      alert(`Access denied. Administrator privileges required.\nYour role: ${role}\n\nRedirecting to home page...`);
      window.location.replace("/home.html");
    } else {
      console.log("‚úÖ Admin access granted - showing page");
      document.body.style.display = "flex";
    }
  </script>

  <div id="header-container"></div>

  <div class="form-card">
    <h1>Edit Product</h1>
    <form id="editForm" enctype="multipart/form-data">
      <div class="form-grid">
        <div>
          <label for="name">Product Name *</label>
          <input type="text" name="name" id="name" required minlength="2" maxlength="100" />
        </div>
        <div>
          <label for="brand">Brand *</label>
          <input type="text" name="brand" id="brand" required minlength="2" maxlength="50" />
        </div>
        <div>
          <label for="price">Price (‚Ç±) *</label>
          <input type="number" name="price" id="price" required min="0.01" step="0.01" />
        </div>
        <div>
          <label for="ram">RAM *</label>
          <input type="text" name="ram" id="ram" required pattern="^[0-9]+\s?(GB|TB|MB)$" placeholder="e.g., 8GB" />
        </div>
        <div>
          <label for="storage">Storage *</label>
          <input type="text" name="storage" id="storage" required pattern="^[0-9]+\s?(GB|TB|MB)$" placeholder="e.g., 256GB" />
        </div>
        <div>
          <label for="availability">Availability *</label>
          <select name="availability" id="availability" required>
            <option value="">Select Availability</option>
            <option value="1">Available</option>
            <option value="0">Unavailable</option>
          </select>
        </div>
        <div class="full-width">
          <label for="images">Upload New Images (Optional - Max 5 images, 5MB each)</label>
          <input type="file" name="images" id="images" accept="image/jpeg,image/jpg,image/png,image/gif" multiple />
          <small>Leave empty to keep existing images. Supported: JPG, PNG, GIF</small>
        </div>
        <div class="full-width">
          <label for="quantity">Quantity in Stock *</label>
          <input type="number" name="quantity" id="quantity" required min="0" max="9999" />
        </div>
        <div class="full-width">
          <label for="mainPhoto">Main Photo Index *</label>
          <input type="number" name="mainPhoto" id="mainPhoto" min="1" value="1" />
          <small>Which image should be the main photo (1 = first image)</small>
        </div>
        <div class="full-width">
          <label for="description">Product Description *</label>
          <textarea name="description" id="description" rows="4" required minlength="10" maxlength="500" placeholder="Describe the product features..."></textarea>
        </div>
      </div>
      <button type="submit">Update Product</button>
    </form>
    <p id="status"></p>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/additional-methods.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    // ‚úÖ jQuery Validation for Product Editing
    $(document).ready(function() {
      
      // Custom validation methods
      $.validator.addMethod("filesize", function(value, element, param) {
        if (element.files.length === 0) return true;
        for (let i = 0; i < element.files.length; i++) {
          if (element.files[i].size > param) return false;
        }
        return true;
      }, "File size must be less than 5MB");

      $.validator.addMethod("maxfiles", function(value, element, param) {
        return element.files.length <= param;
      }, "Maximum 5 files allowed");

      $.validator.addMethod("validMainPhoto", function(value, element) {
        const files = $("#images")[0].files;
        const mainPhotoIndex = parseInt(value);
        
        // If no new images uploaded, any reasonable index is okay
        if (files.length === 0) return mainPhotoIndex >= 1 && mainPhotoIndex <= 10;
        
        // If new images uploaded, check against new image count
        return mainPhotoIndex >= 1 && mainPhotoIndex <= files.length;
      }, "Main photo index must be valid");

      // Initialize validation
      $("#editForm").validate({
        rules: {
          name: {
            required: true,
            minlength: 2,
            maxlength: 100
          },
          brand: {
            required: true,
            minlength: 2,
            maxlength: 50
          },
          price: {
            required: true,
            min: 0.01,
            max: 999999
          },
          ram: {
            required: true,
            pattern: /^[0-9]+\s?(GB|TB|MB)$/i
          },
          storage: {
            required: true,
            pattern: /^[0-9]+\s?(GB|TB|MB)$/i
          },
          availability: {
            required: true
          },
          images: {
            accept: "image/jpeg,image/jpg,image/png,image/gif",
            filesize: 5242880, // 5MB in bytes
            maxfiles: 5
          },
          mainPhoto: {
            required: true,
            min: 1,
            validMainPhoto: true
          },
          quantity: {
            required: true,
            min: 0,
            max: 9999,
            digits: true
          },
          description: {
            required: true,
            minlength: 10,
            maxlength: 500
          }
        },
        messages: {
          name: {
            required: "Product name is required",
            minlength: "Product name must be at least 2 characters",
            maxlength: "Product name cannot exceed 100 characters"
          },
          brand: {
            required: "Brand is required",
            minlength: "Brand must be at least 2 characters",
            maxlength: "Brand cannot exceed 50 characters"
          },
          price: {
            required: "Price is required",
            min: "Price must be greater than 0",
            max: "Price cannot exceed ‚Ç±999,999"
          },
          ram: {
            required: "RAM specification is required",
            pattern: "Please enter valid RAM format (e.g., 8GB, 16GB)"
          },
          storage: {
            required: "Storage specification is required",
            pattern: "Please enter valid storage format (e.g., 256GB, 1TB)"
          },
          availability: {
            required: "Please select availability status"
          },
          images: {
            accept: "Only JPG, PNG, and GIF images are allowed"
          },
          mainPhoto: {
            required: "Main photo index is required",
            min: "Main photo index must be at least 1"
          },
          quantity: {
            required: "Quantity is required",
            min: "Quantity cannot be negative",
            max: "Quantity cannot exceed 9999",
            digits: "Quantity must be a whole number"
          },
          description: {
            required: "Product description is required",
            minlength: "Description must be at least 10 characters",
            maxlength: "Description cannot exceed 500 characters"
          }
        },
        errorClass: "error",
        validClass: "valid",
        errorPlacement: function(error, element) {
          error.insertAfter(element);
        },
        highlight: function(element) {
          $(element).addClass("error").removeClass("valid");
        },
        unhighlight: function(element) {
          $(element).removeClass("error").addClass("valid");
        },
        submitHandler: function(form) {
          // Show loading state
          const submitBtn = $(form).find('button[type="submit"]');
          const originalText = submitBtn.text();
          submitBtn.text('Updating Product...').prop('disabled', true);

          // Get JWT token from storage
          const token = localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken");
          
          if (!token) {
            $("#status").text("Authentication required. Please log in again.").css("color", "red");
            submitBtn.text(originalText).prop('disabled', false);
            setTimeout(() => {
              window.location.href = "/login.html";
            }, 2000);
            return;
          }

          // Create FormData and submit with Authorization header
          const formData = new FormData(form);
          
          fetch(`/api/products/${productId}`, {
            method: "POST",
            headers: {
              "Authorization": "Bearer " + token
            },
            body: formData
          })
          .then(response => {
            if (response.status === 401) {
              throw new Error("Authentication expired. Please log in again.");
            }
            return response.json();
          })
          .then(result => {
            $("#status").text(result.message || "Product updated successfully!").css("color", "green");
            setTimeout(() => {
              window.location.href = "/viewproduct.html";
            }, 1500);
          })
          .catch(error => {
            console.error(error);
            if (error.message.includes("Authentication expired")) {
              $("#status").text(error.message).css("color", "red");
              setTimeout(() => {
                window.location.href = "/login.html";
              }, 2000);
            } else {
              $("#status").text("Error updating product. Please try again.").css("color", "red");
              submitBtn.text(originalText).prop('disabled', false);
            }
          });
        }
      });

      // Real-time validation for file input
      $("#images").on("change", function() {
        const files = this.files;
        const maxPhotosField = $("#mainPhoto");
        
        if (files.length > 0) {
          maxPhotosField.attr("max", files.length);
          if (parseInt(maxPhotosField.val()) > files.length) {
            maxPhotosField.val(1);
          }
        }
        
        // Validate individual file sizes
        for (let i = 0; i < files.length; i++) {
          if (files[i].size > 5242880) { // 5MB
            $(this).addClass("error");
            $(this).after(`<label class="error">File "${files[i].name}" is too large (max 5MB)</label>`);
            return;
          }
        }
      });
    });

    async function loadProduct() {
      try {
        const res = await fetch(`/api/products`);
        const products = await res.json();
        const product = products.find(p => p.productID == productId);
        
        if (!product) {
          $("#status").text("Product not found").css("color", "red");
          return;
        }

        // Populate form fields
        $("#name").val(product.name);
        $("#brand").val(product.brand);
        $("#price").val(product.price);
        $("#ram").val(product.ram);
        $("#storage").val(product.storage);
        $("#quantity").val(product.quantity);
        $("#availability").val(product.availability);
        $("#mainPhoto").val(product.mainPhoto || 1);
        $("#description").val(product.description || "");
        
        // Clear any existing validation errors after loading
        $("#editForm").validate().resetForm();
        
      } catch (error) {
        console.error("Error loading product:", error);
        $("#status").text("Error loading product data").css("color", "red");
      }
    }

    // Load product data when page loads
    loadProduct();
  </script>

  <script>
    // ‚úÖ Enhanced Admin-only page protection with SweetAlert
    function checkAdminAccess() {
      // Prioritize jwtToken as requested
      const token = sessionStorage.getItem("jwtToken") || localStorage.getItem("jwtToken") ||
                    sessionStorage.getItem("token") || localStorage.getItem("token");
      const role = sessionStorage.getItem("role") || localStorage.getItem("role");
      
      console.log("üîê Checking admin access for editproduct.html");
      console.log("Token present:", !!token);
      console.log("User role:", role);
      
      if (!token) {
        console.log("‚ùå No authentication token found - redirecting to login");
        
        Swal.fire({
          icon: 'warning',
          title: 'Authentication Required',
          text: 'Please log in to access this page.',
          confirmButtonText: 'Go to Login',
          confirmButtonColor: '#6c63ff',
          allowOutsideClick: false
        }).then(() => {
          window.location.href = "/login.html";
        });
        return false;
      }
      
      if (role !== "admin") {
        console.log(`‚ùå Access denied - Role: ${role}, Required: admin`);
        
        Swal.fire({
          icon: 'error',
          title: 'Access Denied',
          text: `You are not authorized to access this page. Administrator privileges required.\n\nYour role: ${role || 'none'}`,
          confirmButtonText: 'Go to Home',
          confirmButtonColor: '#6c63ff',
          allowOutsideClick: false
        }).then(() => {
          window.location.href = "/home.html";
        });
        return false;
      }
      
      console.log("‚úÖ Admin access granted");
      return true;
    }
    
    // Check access immediately when page loads
    if (!checkAdminAccess()) {
      // If access check fails, stop page execution
      document.body.style.display = 'none';
    }
  </script>

  <script>
    // Load header and check admin role (prioritize jwtToken)
    $("#header-container").load("header.html", function () {
      const role = sessionStorage.getItem("role") || localStorage.getItem("role");
      if (role === "admin") {
        const editUsersLink = document.getElementById("editUsersLink");
        const dashboardLink = document.getElementById("dashboardLink");
        if (editUsersLink) editUsersLink.style.display = "inline-block";
        if (dashboardLink) dashboardLink.style.display = "inline-block";
      }
    });
  </script>

</body>
</html>
